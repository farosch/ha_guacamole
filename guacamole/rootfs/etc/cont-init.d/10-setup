#!/usr/bin/with-contenv bashio
# Initialize persistent dirs, database, and Guacamole config on first run
set -euo pipefail

bashio::log.info "Preparing persistent directories"
mkdir -p /data/mysql /data/guacamole/extensions /data/guacamole/lib
chown -R mysql:mysql /data/mysql

DB_USER=$(bashio::config 'db_user')
DB_PASSWORD=$(bashio::config 'db_password')
DB_NAME="guacamole_db"

# Copy JDBC extension jars to GUACAMOLE_HOME if missing
if [ ! -f "/data/guacamole/extensions/guacamole-auth-jdbc-mysql-${GUAC_VERSION}.jar" ]; then
  bashio::log.info "Installing Guacamole JDBC MySQL extension"
  cp "/opt/guacamole/guacamole-auth-jdbc-${GUAC_VERSION}/mysql/guacamole-auth-jdbc-mysql-${GUAC_VERSION}.jar" \
     "/data/guacamole/extensions/"
fi
if [ ! -f "/data/guacamole/lib/mysql-connector-j.jar" ]; then
  cp "/opt/guacamole/mysql-connector-j.jar" "/data/guacamole/lib/"
fi

# Create default guacamole.properties if missing
if [ ! -f "/data/guacamole/guacamole.properties" ]; then
  bashio::log.info "Generating guacamole.properties"
  cat > /data/guacamole/guacamole.properties <<EOF
# guacd
guacd-hostname: 127.0.0.1
guacd-port: 4822

# MySQL auth
mysql-hostname: 127.0.0.1
mysql-port: 3306
mysql-database: ${DB_NAME}
mysql-username: ${DB_USER}
mysql-password: ${DB_PASSWORD}
EOF
fi

# Initialize MariaDB data dir if first run
if [ ! -d "/data/mysql/mysql" ]; then
  bashio::log.info "Initializing MariaDB data directory"
  mariadb-install-db --user=mysql --datadir=/data/mysql --basedir=/usr >/dev/null
  touch /data/.mysql_first_run
fi

# Start temporary MariaDB to create DB/user and load schema on first run
bashio::log.info "Starting temporary MariaDB for initialization"
mysqld --user=mysql --datadir=/data/mysql --socket=/run/mysqld/mysqld.sock --bind-address=127.0.0.1 --skip-networking=0 &
MYSQL_PID=$!

# Wait for MariaDB to be ready
for i in $(seq 1 50); do
  if mysqladmin --protocol=tcp -h127.0.0.1 -uroot ping >/dev/null 2>&1; then
    break
  fi
  sleep 0.5
done

if ! mysql --protocol=tcp -h127.0.0.1 -uroot -e 'SELECT 1' >/dev/null 2>&1; then
  bashio::log.error "MariaDB did not start for initialization"
  kill ${MYSQL_PID} || true
  exit 1
fi

# If first run, create DB, user, and load schema
if [ -f /data/.mysql_first_run ]; then
  bashio::log.info "Creating database, user and loading Guacamole schema"
  mysql --protocol=tcp -h127.0.0.1 -uroot <<SQL
CREATE DATABASE IF NOT EXISTS ${DB_NAME};
CREATE USER IF NOT EXISTS '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASSWORD}';
CREATE USER IF NOT EXISTS '${DB_USER}'@'127.0.0.1' IDENTIFIED BY '${DB_PASSWORD}';
GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP,ALTER,REFERENCES,INDEX ON ${DB_NAME}.* TO '${DB_USER}'@'localhost';
GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP,ALTER,REFERENCES,INDEX ON ${DB_NAME}.* TO '${DB_USER}'@'127.0.0.1';
FLUSH PRIVILEGES;
SQL
  mysql --protocol=tcp -h127.0.0.1 -uroot ${DB_NAME} < \
    "/opt/guacamole/guacamole-auth-jdbc-${GUAC_VERSION}/mysql/schema/001-create-schema.sql"
  mysql --protocol=tcp -h127.0.0.1 -uroot ${DB_NAME} < \
    "/opt/guacamole/guacamole-auth-jdbc-${GUAC_VERSION}/mysql/schema/002-create-admin-user.sql"
  mysql --protocol=tcp -h127.0.0.1 -uroot ${DB_NAME} < \
    "/opt/guacamole/guacamole-auth-jdbc-${GUAC_VERSION}/mysql/schema/003-create-logging.sql"
  rm -f /data/.mysql_first_run
fi

# Stop temporary MariaDB; s6 service will start it
kill ${MYSQL_PID}
wait ${MYSQL_PID} || true
bashio::log.info "Initialization complete"
