#!/usr/bin/with-contenv sh
# Initialize persistent dirs, database, and Guacamole config on first run
set -e

echo "[init] Preparing persistent directories"
mkdir -p /data/mysql /data/guacamole/extensions /data/guacamole/lib
chown -R mysql:mysql /data/mysql
mkdir -p /run/mysqld
chown -R mysql:mysql /run/mysqld
chmod 0775 /run/mysqld
rm -f /run/mysqld/mysqld.sock

# Read options from HA options.json
DB_USER=$(jq -r '.db_user' /data/options.json)
DB_PASSWORD=$(jq -r '.db_password' /data/options.json)
DB_NAME="guacamole_db"
ADMIN_PASSWORD=$(jq -r '.admin_password' /data/options.json)

# Copy JDBC extension jars to GUACAMOLE_HOME if missing
if [ ! -f "/data/guacamole/extensions/guacamole-auth-jdbc-mysql-${GUAC_VERSION}.jar" ]; then
  echo "[init] Installing Guacamole JDBC MySQL extension"
  cp "/opt/guacamole/guacamole-auth-jdbc-${GUAC_VERSION}/mysql/guacamole-auth-jdbc-mysql-${GUAC_VERSION}.jar" \
     "/data/guacamole/extensions/"
fi
if [ ! -f "/data/guacamole/lib/mysql-connector-j.jar" ]; then
  cp "/opt/guacamole/mysql-connector-j.jar" "/data/guacamole/lib/"
fi

# Create default guacamole.properties if missing
if [ ! -f "/data/guacamole/guacamole.properties" ]; then
  echo "[init] Generating guacamole.properties"
  cat > /data/guacamole/guacamole.properties <<EOF
# guacd
guacd-hostname: 127.0.0.1
guacd-port: 4822

# MySQL auth
mysql-hostname: 127.0.0.1
mysql-port: 3306
mysql-database: ${DB_NAME}
mysql-username: ${DB_USER}
mysql-password: ${DB_PASSWORD}
EOF
fi

# Ensure guacd settings use IPv4 localhost even if file pre-exists
if [ -f "/data/guacamole/guacamole.properties" ]; then
  # Remove any existing guacd-hostname/guacd-port lines
  sed -i '/^guacd-hostname:/d' /data/guacamole/guacamole.properties
  sed -i '/^guacd-port:/d' /data/guacamole/guacamole.properties
  # Append enforced settings
  cat >> /data/guacamole/guacamole.properties <<EOF
guacd-hostname: 127.0.0.1
guacd-port: 4822
EOF
fi

# Initialize MariaDB data dir if first run
if [ ! -d "/data/mysql/mysql" ]; then
  echo "[init] Initializing MariaDB data directory"
  mariadb-install-db --user=mysql --datadir=/data/mysql --basedir=/usr >/dev/null
  touch /data/.mysql_first_run
fi

# Start temporary MariaDB to create DB/user and load schema on first run
echo "[init] Starting temporary MariaDB for initialization"
mysqld --user=mysql --datadir=/data/mysql --socket=/run/mysqld/mysqld.sock --bind-address=127.0.0.1 --skip-networking=0 &
MYSQL_PID=$!

# Wait for MariaDB to be ready
for i in $(seq 1 50); do
  if mysqladmin --socket=/run/mysqld/mysqld.sock -uroot ping >/dev/null 2>&1; then
    break
  fi
  sleep 0.5
done

if ! mysql --socket=/run/mysqld/mysqld.sock -uroot -e 'SELECT 1' >/dev/null 2>&1; then
  echo "[init] ERROR: MariaDB did not start for initialization" >&2
  kill ${MYSQL_PID} || true
  exit 1
fi

# If first run, create DB, user, and load schema
if [ -f /data/.mysql_first_run ]; then
  echo "[init] Creating database, user and loading Guacamole schema"
  mysql --socket=/run/mysqld/mysqld.sock -uroot <<SQL
CREATE DATABASE IF NOT EXISTS ${DB_NAME};
CREATE USER IF NOT EXISTS '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASSWORD}';
CREATE USER IF NOT EXISTS '${DB_USER}'@'127.0.0.1' IDENTIFIED BY '${DB_PASSWORD}';
GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP,ALTER,REFERENCES,INDEX ON ${DB_NAME}.* TO '${DB_USER}'@'localhost';
GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP,ALTER,REFERENCES,INDEX ON ${DB_NAME}.* TO '${DB_USER}'@'127.0.0.1';
FLUSH PRIVILEGES;
SQL
  SCHEMA_DIR="/opt/guacamole/guacamole-auth-jdbc-${GUAC_VERSION}/mysql/schema"
  if [ -d "${SCHEMA_DIR}" ]; then
    echo "[init] Importing Guacamole MySQL schema from ${SCHEMA_DIR}"
    # Import all .sql files in sorted order to handle version differences
    for sql in $(ls -1 "${SCHEMA_DIR}"/*.sql 2>/dev/null | sort); do
      echo "[init] Applying $(basename "$sql")"
      mysql --socket=/run/mysqld/mysqld.sock -uroot ${DB_NAME} < "$sql"
    done
  else
    echo "[init] ERROR: Schema directory not found: ${SCHEMA_DIR}" >&2
    kill ${MYSQL_PID} || true
    exit 1
  fi
  # Set admin password per add-on config on first run
  if [ -n "${ADMIN_PASSWORD}" ] && [ "${ADMIN_PASSWORD}" != "null" ]; then
    echo "[init] Applying configured admin password for user 'guacadmin'"
    # Detect column names to support schema differences
    USER_COL=$(mysql --socket=/run/mysqld/mysqld.sock -uroot -N ${DB_NAME} -e "SHOW COLUMNS FROM guacamole_user LIKE 'username';" | awk '{print $1}')
    if [ -z "${USER_COL}" ]; then
      USER_COL=$(mysql --socket=/run/mysqld/mysqld.sock -uroot -N ${DB_NAME} -e "SHOW COLUMNS FROM guacamole_user LIKE 'user_name';" | awk '{print $1}')
    fi
    if [ -z "${USER_COL}" ]; then
      echo "[init] WARNING: Could not detect username column in guacamole_user; skipping admin password set" >&2
    else
      SET_CLAUSES="password_hash = UNHEX(SHA2(CONCAT('${ADMIN_PASSWORD}', HEX(password_salt)), 256)), password_date = NOW()"
      HAS_DISABLED=$(mysql --socket=/run/mysqld/mysqld.sock -uroot -N ${DB_NAME} -e "SHOW COLUMNS FROM guacamole_user LIKE 'disabled';" | wc -l)
      HAS_EXPIRED=$(mysql --socket=/run/mysqld/mysqld.sock -uroot -N ${DB_NAME} -e "SHOW COLUMNS FROM guacamole_user LIKE 'expired';" | wc -l)
      if [ "${HAS_DISABLED}" = "1" ]; then
        SET_CLAUSES="${SET_CLAUSES}, disabled = 0"
      fi
      if [ "${HAS_EXPIRED}" = "1" ]; then
        SET_CLAUSES="${SET_CLAUSES}, expired = 0"
      fi
      mysql --socket=/run/mysqld/mysqld.sock -uroot ${DB_NAME} -e "UPDATE guacamole_user SET ${SET_CLAUSES} WHERE ${USER_COL} = 'guacadmin';"
    fi
  fi
  rm -f /data/.mysql_first_run
fi

# Stop temporary MariaDB; s6 service will start it
if kill -0 ${MYSQL_PID} >/dev/null 2>&1; then
  kill ${MYSQL_PID} || true
  wait ${MYSQL_PID} || true
fi
echo "[init] Initialization complete"
