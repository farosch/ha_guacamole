#!/usr/bin/with-contenv sh
# Initialize persistent dirs, database, and Guacamole config on first run
set -e

echo "[init] Preparing persistent directories"
mkdir -p /data/mysql /data/guacamole/extensions /data/guacamole/lib
chown -R mysql:mysql /data/mysql
mkdir -p /run/mysqld
chown -R mysql:mysql /run/mysqld
chmod 0775 /run/mysqld
rm -f /run/mysqld/mysqld.sock

# Credentials: predefined DB username, random password on first install
DB_NAME="guacamole_db"
DB_USER="guacamole"
CRED_FILE="/data/guacamole/credentials.env"
if [ -f "$CRED_FILE" ]; then
  # Load existing credentials
  . "$CRED_FILE"
else
  # Generate a random alphanumeric password (24 chars)
  DB_PASSWORD=$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 24)
  # Persist credentials for future runs
  mkdir -p /data/guacamole
  cat > "$CRED_FILE" <<EOF
DB_USER=${DB_USER}
DB_PASSWORD=${DB_PASSWORD}
EOF
fi

# Copy JDBC extension jars to GUACAMOLE_HOME if missing
if [ ! -f "/data/guacamole/extensions/guacamole-auth-jdbc-mysql-${GUAC_VERSION}.jar" ]; then
  echo "[init] Installing Guacamole JDBC MySQL extension"
  cp "/opt/guacamole/guacamole-auth-jdbc-${GUAC_VERSION}/mysql/guacamole-auth-jdbc-mysql-${GUAC_VERSION}.jar" \
     "/data/guacamole/extensions/"
fi
if [ ! -f "/data/guacamole/lib/mysql-connector-j.jar" ]; then
  cp "/opt/guacamole/mysql-connector-j.jar" "/data/guacamole/lib/"
fi

# Create or update guacamole.properties with generated credentials
if [ ! -f "/data/guacamole/guacamole.properties" ]; then
  echo "[init] Generating guacamole.properties"
  cat > /data/guacamole/guacamole.properties <<EOF
# guacd
guacd-hostname: 127.0.0.1
guacd-port: 4822

# MySQL auth
mysql-hostname: 127.0.0.1
mysql-port: 3306
mysql-database: ${DB_NAME}
mysql-username: ${DB_USER}
mysql-password: ${DB_PASSWORD}
EOF
else
  # Ensure DB credentials reflect generated values
  sed -i \
    -e "s/^mysql-username:.*/mysql-username: ${DB_USER}/" \
    -e "s/^mysql-password:.*/mysql-password: ${DB_PASSWORD}/" \
    -e "s/^mysql-database:.*/mysql-database: ${DB_NAME}/" \
    /data/guacamole/guacamole.properties
fi

# Ensure guacd settings use IPv4 localhost even if file pre-exists
if [ -f "/data/guacamole/guacamole.properties" ]; then
  # Remove any existing guacd-hostname/guacd-port lines
  sed -i '/^guacd-hostname:/d' /data/guacamole/guacamole.properties
  sed -i '/^guacd-port:/d' /data/guacamole/guacamole.properties
  # Append enforced settings
  cat >> /data/guacamole/guacamole.properties <<EOF
guacd-hostname: 127.0.0.1
guacd-port: 4822
EOF
fi

# Initialize MariaDB data dir if first run
if [ ! -d "/data/mysql/mysql" ]; then
  echo "[init] Initializing MariaDB data directory"
  mariadb-install-db --user=mysql --datadir=/data/mysql --basedir=/usr >/dev/null
  touch /data/.mysql_first_run
fi

# Start temporary MariaDB to create DB/user and load schema on first run
echo "[init] Starting temporary MariaDB for initialization"
/usr/bin/mariadbd --user=mysql --datadir=/data/mysql --socket=/run/mysqld/mysqld.sock --bind-address=127.0.0.1 --skip-networking=0 &
MYSQL_PID=$!

# Wait for MariaDB to be ready
for i in $(seq 1 50); do
  if mysqladmin --socket=/run/mysqld/mysqld.sock -uroot ping >/dev/null 2>&1; then
    break
  fi
  sleep 0.5
done

if ! mysql --socket=/run/mysqld/mysqld.sock -uroot -e 'SELECT 1' >/dev/null 2>&1; then
  echo "[init] ERROR: MariaDB did not start for initialization" >&2
  kill ${MYSQL_PID} || true
  exit 1
fi

# If first run, create DB, user, and load schema
if [ -f /data/.mysql_first_run ]; then
  echo "[init] Creating database, user and loading Guacamole schema"
  mysql --socket=/run/mysqld/mysqld.sock -uroot <<SQL
CREATE DATABASE IF NOT EXISTS ${DB_NAME};
CREATE USER IF NOT EXISTS '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASSWORD}';
CREATE USER IF NOT EXISTS '${DB_USER}'@'127.0.0.1' IDENTIFIED BY '${DB_PASSWORD}';
CREATE USER IF NOT EXISTS '${DB_USER}'@'%' IDENTIFIED BY '${DB_PASSWORD}';
GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP,ALTER,REFERENCES,INDEX ON ${DB_NAME}.* TO '${DB_USER}'@'localhost';
GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP,ALTER,REFERENCES,INDEX ON ${DB_NAME}.* TO '${DB_USER}'@'127.0.0.1';
GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP,ALTER,REFERENCES,INDEX ON ${DB_NAME}.* TO '${DB_USER}'@'%';
FLUSH PRIVILEGES;
SQL
  SCHEMA_DIR="/opt/guacamole/guacamole-auth-jdbc-${GUAC_VERSION}/mysql/schema"
  if [ -d "${SCHEMA_DIR}" ]; then
    echo "[init] Importing Guacamole MySQL schema from ${SCHEMA_DIR}"
    # Import all .sql files in sorted order to handle version differences
    for sql in $(ls -1 "${SCHEMA_DIR}"/*.sql 2>/dev/null | sort); do
      echo "[init] Applying $(basename "$sql")"
      mysql --socket=/run/mysqld/mysqld.sock -uroot ${DB_NAME} < "$sql"
    done
  else
    echo "[init] ERROR: Schema directory not found: ${SCHEMA_DIR}" >&2
    kill ${MYSQL_PID} || true
    exit 1
  fi
  # Output credentials ONCE during initial init
  echo "[init] ------------------------------------------------------"
  echo "[init] Guacamole Admin: guacadmin / guacadmin"
  echo "[init] Database Name: ${DB_NAME}"
  echo "[init] Database User: ${DB_USER}"
  echo "[init] Database Password: ${DB_PASSWORD}"
  printf "[init] \033[31mIMPORTANT: Database password is shown only once.\033[0m\n"
  echo "[init] ------------------------------------------------------"
  rm -f /data/.mysql_first_run
fi

# If not first run, check for and apply JDBC schema upgrades
if [ ! -f /data/.mysql_first_run ]; then
  echo "[init] Checking for JDBC schema upgrade scripts"
  # Ensure migrations tracking table exists
  mysql --socket=/run/mysqld/mysqld.sock -uroot ${DB_NAME} <<SQL
CREATE TABLE IF NOT EXISTS guac_migrations (
  id INT AUTO_INCREMENT PRIMARY KEY,
  script VARCHAR(255) NOT NULL UNIQUE,
  applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;
SQL
  # Prefer schema/upgrade directory; fallback to mysql/upgrade
  SCHEMA_UPGRADE_DIR="/opt/guacamole/guacamole-auth-jdbc-${GUAC_VERSION}/mysql/schema/upgrade"
  ALT_UPGRADE_DIR="/opt/guacamole/guacamole-auth-jdbc-${GUAC_VERSION}/mysql/upgrade"
  UPG_DIR=""
  if [ -d "${SCHEMA_UPGRADE_DIR}" ]; then
    UPG_DIR="${SCHEMA_UPGRADE_DIR}"
  elif [ -d "${ALT_UPGRADE_DIR}" ]; then
    UPG_DIR="${ALT_UPGRADE_DIR}"
  fi
  if [ -n "${UPG_DIR}" ]; then
    echo "[init] Found upgrade directory: ${UPG_DIR}"
    for sql in $(ls -1 "${UPG_DIR}"/*.sql 2>/dev/null | sort); do
      base=$(basename "$sql")
      # Skip if already applied
      if mysql --socket=/run/mysqld/mysqld.sock -uroot ${DB_NAME} -N -e "SELECT 1 FROM guac_migrations WHERE script='${base}'" | grep -q 1; then
        echo "[init] Skipping already applied upgrade: ${base}"
        continue
      fi
      echo "[init] Applying upgrade: ${base}"
      if mysql --socket=/run/mysqld/mysqld.sock -uroot ${DB_NAME} < "$sql"; then
        mysql --socket=/run/mysqld/mysqld.sock -uroot ${DB_NAME} -e "INSERT INTO guac_migrations (script) VALUES ('${base}')"
        echo "[init] Applied upgrade: ${base}"
      else
        echo "[init] ERROR applying upgrade: ${base}" >&2
      fi
    done
  else
    echo "[init] No upgrade directory present for JDBC ${GUAC_VERSION}"
  fi
fi

# Stop temporary MariaDB; s6 service will start it
if kill -0 ${MYSQL_PID} >/dev/null 2>&1; then
  kill ${MYSQL_PID} || true
  wait ${MYSQL_PID} || true
fi
echo "[init] Initialization complete"

# Log available guacd protocol plugins for diagnostics
for proto in ssh rdp vnc telnet; do
  if [ -f "/usr/lib/guacamole/libguac-client-${proto}.so" ] || [ -f "/usr/local/lib/guacamole/libguac-client-${proto}.so" ]; then
    echo "[init] Protocol '${proto}' plugin present"
  else
    echo "[init] WARNING: Protocol '${proto}' plugin missing"
  fi
done

# Dependency diagnostics for protocol plugins (ldd output)
for so in /usr/lib/guacamole/libguac-client-*.so; do
  if [ -f "$so" ]; then
    echo "[init] ldd $so:" && ldd "$so" || true
  fi
done
